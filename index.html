<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absen Digital - SDN 1 Pasirpogor</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Nunito:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* CSS tetap sama seperti sebelumnya */
    </style>
</head>
<body>
    <!-- HTML tetap sama seperti sebelumnya -->
    
    <script>
        // ================= KONFIGURASI SHEETDB =================
        const SHEETDB_URL = "https://sheetdb.io/api/v1/5050u4yo2zvvn";
        const SHEETDB_URL_REKAP_BULANAN = `${SHEETDB_URL}/sheets/RekapBulanan`;
        
        // ================= DAFTAR SISWA =================
        const defaultStudents = [
            "AIRA ALFANISA", "ALVARO ABU RIZIQ", "AZAHRA MIKAILA PUTRI", "DAFFA SYADID AL GHIFARI", "DAVITA SHEILA NURASYIFA",
            "DIMAS SAID HAIDIR", "DZAKIRA ASSYABIYA RAFIFA", "HAYISAM NUGRAHA", "HILMA SYAKILA RAHMADANI", "KIRANA PUTRI SOFYAN",
            "MEZZA RIZKI MUNANDAR", "MUHAMAD IQBAL RACHMADENI", "MUHAMAD JUNA", "MUHAMAD RIZQI KURNIAWAN", "MUHAMAD SYAHDAN",
            "MUHAMAD WILDAN RAMDANI", "MUHAMMAD AFANDI RAHMAN", "MUHAMMAD SAHDAN ALMUHAIMIN", "NADILA AINA ZAHRA",
            "NAUFAL FADIL PRATAMA", "NAYLA PUTRI LUTHPIANA", "RAHAP", "SAHLA YUSHIRA ALMAHA", "SALWA TUNNISA HANIFAH",
            "SRI WAHYUNI", "UPAIRA NUR APIPAH"
        ];
        
        const statusOptions = [
            { text: "‚úîÔ∏è Hadir", value: "Hadir" },
            { text: "üìÑ Izin", value: "Izin" },
            { text: "ü§í Sakit", value: "Sakit" },
            { text: "‚ùå Alfa", value: "Alfa" }
        ];
        
        let attendanceData = {};
        let students = [...defaultStudents];
        let selectedDate = new Date();
        let searchTimeout;

        // ================= FUNGSI UTAMA =================
        document.addEventListener('DOMContentLoaded', function() {
            // Inisialisasi aplikasi
            initApp();
            
            // Event listeners
            setupEventListeners();
        });

        function initApp() {
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            // Set tanggal default ke hari ini
            const today = new Date();
            const formattedToday = formatDateInput(today);
            document.getElementById('attendance-date').value = formattedToday;
            updateSelectedDateDisplay(today);
            loadAttendanceForDate(today);
        }

        function setupEventListeners() {
            // Login Form
            const loginForm = document.getElementById('loginForm');
            const errorMsg = document.getElementById('error-message');
            
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value.trim();
                
                if (username === 'lita' && password === 'kelas5') {
                    showSlide('home-page');
                    errorMsg.style.display = 'none';
                } else {
                    errorMsg.style.display = 'block';
                    document.getElementById('password').value = '';
                }
            });
            
            document.getElementById('username').addEventListener('input', () => errorMsg.style.display='none');
            document.getElementById('password').addEventListener('input', () => errorMsg.style.display='none');
            document.getElementById('togglePasswordBtn').addEventListener('click', togglePassword);
            document.getElementById('togglePasswordBtn').addEventListener('keypress', function(e) {
                if (e.key === "Enter" || e.key === " ") togglePassword();
            });

            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', function() {
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                showSlide('login-page');
            });

            // Date picker
            document.getElementById('attendance-date').addEventListener('change', function() {
                const date = new Date(this.value);
                selectedDate = date;
                updateSelectedDateDisplay(date);
                loadAttendanceForDate(date);
            });
            
            // Tombol Muat Kehadiran
            document.getElementById('btnLoadAttendance').addEventListener('click', function() {
                const dateInput = document.getElementById('attendance-date').value;
                if (dateInput) {
                    const date = new Date(dateInput);
                    selectedDate = date;
                    updateSelectedDateDisplay(date);
                    loadAttendanceForDate(date);
                }
            });

            // Tombol Aksi
            document.getElementById('btnHadirSemua').addEventListener('click', markAllPresent);
            document.getElementById('btnKirimAbsen').addEventListener('click', submitAttendance);
            document.getElementById('btnRekapHarian').addEventListener('click', showRekapHarian);
            document.getElementById('btnRekapBulanan').addEventListener('click', showRekapBulanan);
            document.getElementById('closeRekapModal').addEventListener('click', closeRekapModal);
            document.getElementById('rekapModal').addEventListener('click', function(e){
                if(e.target === this) closeRekapModal();
            });
        }

        // ================= FUNGSI UTILITAS =================
        function formatDateInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDate(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}-${month}-${year}`;
        }

        function updateSelectedDateDisplay(date) {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('selected-date-display').textContent = 
                date.toLocaleDateString('id-ID', options);
        }

        function updateDateTime() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('current-date').textContent = now.toLocaleDateString('id-ID', options);
            
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            document.getElementById('digital-clock').textContent = `${hours}:${minutes}:${seconds}`;
        }

        function showSlide(slideId) {
            document.querySelectorAll('.slide-container').forEach(slide => {
                slide.classList.remove('active');
            });
            document.getElementById(slideId).classList.add('active');
        }

        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const icon = document.getElementById('togglePasswordBtn');
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.classList.replace('fa-eye-slash', 'fa-eye');
            } else {
                passwordInput.type = 'password';
                icon.classList.replace('fa-eye', 'fa-eye-slash');
            }
        }

        function getInitials(name) {
            const parts = name.split(' ');
            if (parts.length === 1) {
                return parts[0].substring(0,2).toUpperCase();
            }
            return parts.map(part => part[0]).join('').substring(0,2).toUpperCase();
        }

        // ================= FUNGSI ABSENSI =================
        async function loadAttendanceForDate(date) {
            const formattedDate = formatDate(date);
            document.getElementById('students-container').innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Memuat data...</div>';
            
            try {
                const res = await fetch(`${SHEETDB_URL}/search?Tanggal=${encodeURIComponent(formattedDate)}`);
                const data = await res.json();
                attendanceData = {};
                
                if (Array.isArray(data) && data.length > 0) {
                    data.forEach(item => {
                        if (item["Nama Siswa"] && item["Status Kehadiran"]) {
                            attendanceData[item["Nama Siswa"]] = item["Status Kehadiran"];
                        }
                    });
                    
                    // Set default 'Alfa' untuk siswa yang tidak ada datanya
                    students.forEach(student => {
                        if (!attendanceData[student]) {
                            attendanceData[student] = 'Alfa';
                        }
                    });
                } else {
                    // Jika tidak ada data, set semua siswa sebagai 'Alfa'
                    students.forEach(student => {
                        attendanceData[student] = 'Alfa';
                    });
                }
                
                generateStudentCards();
            } catch (e) {
                console.error("Error loading attendance:", e);
                students.forEach(student => {
                    attendanceData[student] = 'Alfa';
                });
                generateStudentCards();
                document.getElementById('students-container').innerHTML += '<div class="no-data" style="color:#e74c3c;">Gagal memuat data absensi!</div>';
            }
        }

        function generateStudentCards() {
            const container = document.getElementById('students-container');
            container.innerHTML = '';
            
            students.forEach((student) => {
                if (!attendanceData[student]) {
                    attendanceData[student] = 'Alfa';
                }
                
                const card = document.createElement('div');
                card.className = 'student-card';
                
                const select = document.createElement('select');
                select.className = 'attendance-status';
                
                statusOptions.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.text;
                    if (attendanceData[student] === opt.value) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
                
                select.addEventListener('change', function() {
                    updateAttendance(student, select.value);
                });
                
                card.innerHTML = `
                    <div class="student-avatar">${getInitials(student)}</div>
                    <div class="student-name">${student}</div>
                `;
                
                card.appendChild(select);
                container.appendChild(card);
            });
        }

        function updateAttendance(student, status) {
            attendanceData[student] = status;
        }

        function markAllPresent() {
            const btn = document.getElementById('btnHadirSemua');
            btn.innerHTML = '<i class="fas fa-check"></i> Berhasil!';
            btn.style.backgroundColor = '#2ecc71';
            
            setTimeout(() => {
                btn.innerHTML = '<i class="fas fa-user-check"></i> Hadir Semua';
                btn.style.backgroundColor = '';
            }, 2000);
            
            students.forEach(student => {
                attendanceData[student] = 'Hadir';
            });
            generateStudentCards();
        }

        async function submitAttendance() {
            const formattedDate = formatDate(selectedDate);
            const dataArr = students.map(nama => ({
                Tanggal: formattedDate,
                "Nama Siswa": nama,
                "Status Kehadiran": attendanceData[nama] || 'Alfa'
            }));
            
            const message = document.getElementById('success-message');
            let sukses = 0, gagal = 0;
            
            try {
                // Coba kirim semua data sekaligus
                const res = await fetch(SHEETDB_URL, {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({ data: dataArr })
                });
                
                if (res.ok) {
                    sukses = students.length;
                } else {
                    // Jika gagal, coba kirim satu per satu
                    for (const nama of students) {
                        const data = {
                            Tanggal: formattedDate,
                            "Nama Siswa": nama,
                            "Status Kehadiran": attendanceData[nama] || 'Alfa'
                        };
                        
                        try {
                            const resSingle = await fetch(SHEETDB_URL, {
                                method: "POST",
                                headers: {"Content-Type": "application/json"},
                                body: JSON.stringify({ data })
                            });
                            
                            if (resSingle.ok) sukses++; 
                            else gagal++;
                        } catch (e) {
                            gagal++;
                        }
                    }
                }
            } catch (e) {
                // Jika error jaringan, coba kirim satu per satu
                for (const nama of students) {
                    const data = {
                        Tanggal: formattedDate,
                        "Nama Siswa": nama,
                        "Status Kehadiran": attendanceData[nama] || 'Alfa'
                    };
                    
                    try {
                        const resSingle = await fetch(SHEETDB_URL, {
                            method: "POST",
                            headers: {"Content-Type": "application/json"},
                            body: JSON.stringify({ data })
                        });
                        
                        if (resSingle.ok) sukses++; 
                        else gagal++;
                    } catch (e) {
                        gagal++;
                    }
                }
            }
            
            // Tampilkan pesan hasil
            if (sukses > 0 && gagal === 0) {
                message.textContent = 'Semua absensi berhasil dikirim!';
                message.style.backgroundColor = '#2ecc71';
            } else if (sukses > 0) {
                message.textContent = `Sebagian absensi berhasil (${sukses}), gagal (${gagal}).`;
                message.style.backgroundColor = '#f39c12';
            } else {
                message.textContent = 'Gagal kirim absensi!';
                message.style.backgroundColor = '#e74c3c';
            }
            
            message.style.display = 'block';
            setTimeout(() => {
                message.style.display = 'none';
            }, 3000);

            // Muat ulang data absensi
            await loadAttendanceForDate(selectedDate);
        }

        // ================= FUNGSI REKAP =================
        function showRekapModal(contentHTML) {
            document.getElementById('rekapModalContent').innerHTML = 
                '<span class="close-modal" id="closeRekapModal">&times;</span>' + contentHTML;
            document.getElementById('rekapModal').classList.add('active');
            document.getElementById('closeRekapModal').addEventListener('click', closeRekapModal);
        }

        function closeRekapModal() {
            document.getElementById('rekapModal').classList.remove('active');
        }

        // REKAP HARIAN
        function showRekapHarian() {
            let dateInputHTML = `
                <div class="rekap-controls">
                    <label for="rekapTanggal"><b>Pilih Tanggal:</b></label>
                    <input type="date" id="rekapTanggal" value="${formatDateInput(selectedDate)}">
                    <button id="btnCariRekapHarian" class="action-button submit-attendance" style="padding:7px 15px;">
                        <i class="fas fa-search"></i> Tampilkan
                    </button>
                </div>
                <div id="rekapHarianResult"></div>
            `;
            
            showRekapModal(`<h2>Rekap Harian</h2>${dateInputHTML}`);
            
            document.getElementById('btnCariRekapHarian').addEventListener('click', function() {
                const tanggal = document.getElementById('rekapTanggal').value;
                if (tanggal) {
                    const dateObj = new Date(tanggal);
                    loadRekapHarian(dateObj);
                }
            });
            
            loadRekapHarian(selectedDate);
        }

        async function loadRekapHarian(date) {
            const formattedDate = formatDate(date);
            const resultDiv = document.getElementById('rekapHarianResult');
            
            if (isNaN(date.getTime())) {
                resultDiv.innerHTML = `<div class="no-data">Tanggal tidak valid!</div>`;
                return;
            }
            
            resultDiv.innerHTML = "<div class='loading'><i class='fas fa-spinner fa-spin'></i> Memuat data...</div>";
            
            try {
                const res = await fetch(`${SHEETDB_URL}/search?Tanggal=${encodeURIComponent(formattedDate)}`);
                const data = await res.json();
                
                if (!Array.isArray(data) || data.length === 0) {
                    resultDiv.innerHTML = `<div class="no-data">Tidak ada data absensi untuk tanggal <b>${formattedDate}</b></div>`;
                    return;
                }
                
                let searchHTML = `
                    <div class="search-container">
                        <input type="text" id="searchRekapHarian" placeholder="Cari nama siswa...">
                    </div>
                `;
                
                let tableHTML = `
                    <table class="rekap-table">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Nama Siswa</th>
                                <th>Status Kehadiran</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                let nomor = 1;
                for (let row of data) {
                    const statusClass = `status-${row["Status Kehadiran"]?.toLowerCase() || ''}`;
                    tableHTML += `
                        <tr class="${statusClass}">
                            <td>${nomor++}</td>
                            <td>${row["Nama Siswa"] || "-"}</td>
                            <td>${row["Status Kehadiran"] || "-"}</td>
                        </tr>
                    `;
                }
                
                tableHTML += `</tbody></table>`;
                resultDiv.innerHTML = searchHTML + tableHTML;
                
                // Fungsi pencarian dengan debounce
                document.getElementById('searchRekapHarian').addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        const searchTerm = this.value.toLowerCase();
                        const rows = document.querySelectorAll('.rekap-table tbody tr');
                        
                        rows.forEach(row => {
                            const name = row.cells[1].textContent.toLowerCase();
                            row.style.display = name.includes(searchTerm) ? '' : 'none';
                        });
                    }, 300);
                });
            } catch(e) {
                resultDiv.innerHTML = `
                    <div class="no-data" style="color:#e74c3c">
                        Gagal memuat data: ${e.message}
                    </div>
                `;
            }
        }

        // REKAP BULANAN
        function showRekapBulanan() {
            const now = new Date();
            const thisMonth = String(now.getMonth() + 1).padStart(2, '0');
            const thisYear = now.getFullYear();
            
            const bulanInputHTML = `
                <div class="rekap-controls">
                    <label for="rekapBulan"><b>Pilih Bulan:</b></label>
                    <select id="rekapBulan">
                        ${getBulanOptions(thisMonth)}
                    </select>
                    <label for="rekapTahun"><b>Tahun:</b></label>
                    <input type="number" id="rekapTahun" min="2023" max="${thisYear}" value="${thisYear}" style="width:90px;">
                    <button id="btnCariRekapBulanan" class="action-button rekap-bulanan" style="padding:7px 15px;">
                        <i class="fas fa-search"></i> Tampilkan
                    </button>
                </div>
                <div id="rekapBulananResult"></div>
            `;
            
            showRekapModal(`<h2>Rekap Bulanan</h2>${bulanInputHTML}`);
            
            document.getElementById('btnCariRekapBulanan').addEventListener('click', function() {
                const bulan = document.getElementById('rekapBulan').value;
                const tahun = document.getElementById('rekapTahun').value;
                loadRekapBulanan(bulan, tahun);
            });
            
            loadRekapBulanan(thisMonth, thisYear);
        }

        function getBulanOptions(selected) {
            const bulanArr = [
                "01|Januari", "02|Februari", "03|Maret", "04|April", "05|Mei", "06|Juni",
                "07|Juli", "08|Agustus", "09|September", "10|Oktober", "11|November", "12|Desember"
            ];
            
            return bulanArr.map(b => {
                const [val, label] = b.split('|');
                return `<option value="${val}" ${val === selected ? 'selected' : ''}>${label}</option>`;
            }).join('');
        }

        async function loadRekapBulanan(bulan, tahun) {
            const resultDiv = document.getElementById('rekapBulananResult');
            resultDiv.innerHTML = "<div class='loading'><i class='fas fa-spinner fa-spin'></i> Memuat data...</div>";
            
            try {
                const res = await fetch(SHEETDB_URL);
                const allData = await res.json();
                
                if (!Array.isArray(allData) || allData.length === 0) {
                    resultDiv.innerHTML = `<div class="no-data">Tidak ada data absensi</div>`;
                    return;
                }
                
                // Filter data berdasarkan bulan dan tahun
                const filteredData = allData.filter(row => {
                    if (!row.Tanggal) return false;
                    const [day, month, year] = row.Tanggal.split('-');
                    return month === bulan && year === tahun;
                });
                
                if (filteredData.length === 0) {
                    resultDiv.innerHTML = `
                        <div class="no-data">
                            Tidak ada data absensi untuk bulan <b>${bulan}-${tahun}</b>
                        </div>
                    `;
                    return;
                }
                
                // Kelompokkan data per siswa
                const siswaMap = {};
                for (let row of filteredData) {
                    const nama = row["Nama Siswa"];
                    const status = row["Status Kehadiran"];
                    
                    if (!siswaMap[nama]) {
                        siswaMap[nama] = { Hadir: 0, Izin: 0, Sakit: 0, Alfa: 0 };
                    }
                    
                    if (status === "Hadir") siswaMap[nama].Hadir++;
                    else if (status === "Izin") siswaMap[nama].Izin++;
                    else if (status === "Sakit") siswaMap[nama].Sakit++;
                    else siswaMap[nama].Alfa++;
                }
                
                // Buat tabel rekap
                let searchHTML = `
                    <div class="search-container">
                        <input type="text" id="searchRekapBulanan" placeholder="Cari nama siswa...">
                    </div>
                `;
                
                let tableHTML = `
                    <table class="rekap-table">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Nama Siswa</th>
                                <th>Hadir</th>
                                <th>Izin</th>
                                <th>Sakit</th>
                                <th>Alfa</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                let nomor = 1;
                for (let nama in siswaMap) {
                    const total = siswaMap[nama].Hadir + siswaMap[nama].Izin + 
                                 siswaMap[nama].Sakit + siswaMap[nama].Alfa;
                    
                    tableHTML += `
                        <tr>
                            <td>${nomor++}</td>
                            <td>${nama}</td>
                            <td>${siswaMap[nama].Hadir}</td>
                            <td>${siswaMap[nama].Izin}</td>
                            <td>${siswaMap[nama].Sakit}</td>
                            <td>${siswaMap[nama].Alfa}</td>
                            <td><strong>${total}</strong></td>
                        </tr>
                    `;
                }
                
                tableHTML += `</tbody></table>`;
                
                // Tombol simpan rekap
                const simpanBtnHTML = `
                    <button id="btnSimpanRekapBulanan" class="action-button rekap-bulanan" style="padding:7px 15px; margin-top:10px;">
                        <i class="fas fa-save"></i> Simpan Rekap Bulanan ke Google Sheet
                    </button>
                `;
                
                resultDiv.innerHTML = searchHTML + tableHTML + simpanBtnHTML;
                
                // Fungsi pencarian dengan debounce
                document.getElementById('searchRekapBulanan').addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        const searchTerm = this.value.toLowerCase();
                        const rows = document.querySelectorAll('.rekap-table tbody tr');
                        
                        rows.forEach(row => {
                            const name = row.cells[1].textContent.toLowerCase();
                            row.style.display = name.includes(searchTerm) ? '' : 'none';
                        });
                    }, 300);
                });

                // Handler tombol simpan rekap
                document.getElementById('btnSimpanRekapBulanan').addEventListener('click', function() {
                    simpanRekapBulanan(siswaMap, bulan, tahun);
                });
            } catch(e) {
                resultDiv.innerHTML = `
                    <div class="no-data" style="color:#e74c3c">
                        Gagal memuat data: ${e.message}
                    </div>
                `;
            }
        }

        // SIMPAN REKAP BULANAN KE SHEETDB
        async function simpanRekapBulanan(siswaMap, bulan, tahun) {
            const namaBulan = [
                "Januari", "Februari", "Maret", "April", "Mei", "Juni",
                "Juli", "Agustus", "September", "Oktober", "November", "Desember"
            ][parseInt(bulan)-1] || bulan;
            
            const dataArr = Object.entries(siswaMap).map(([nama, stat]) => ({
                "Nama Siswa": nama,
                "Bulan": namaBulan,
                "Tahun": tahun,
                "Hadir": stat.Hadir,
                "Izin": stat.Izin,
                "Sakit": stat.Sakit,
                "Alfa": stat.Alfa,
                "Total": stat.Hadir + stat.Izin + stat.Sakit + stat.Alfa
            }));
            
            try {
                // Tampilkan loading
                const resultDiv = document.getElementById('rekapBulananResult');
                resultDiv.innerHTML = "<div class='loading'><i class='fas fa-spinner fa-spin'></i> Menyimpan data rekap bulanan...</div>";
                
                const res = await fetch(SHEETDB_URL_REKAP_BULANAN, {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({ data: dataArr })
                });
                
                const result = await res.json();
                
                if (result.created && result.created > 0) {
                    alert(`‚úÖ Berhasil menyimpan ${result.created} data rekap bulanan!`);
                } else {
                    throw new Error(result.error || "Gagal menyimpan data");
                }
            } catch (error) {
                console.error("Error saat menyimpan rekap bulanan:", error);
                
                // Coba simpan satu per satu jika batch gagal
                let sukses = 0;
                const totalData = dataArr.length;
                
                for (const data of dataArr) {
                    try {
                        const res = await fetch(SHEETDB_URL_REKAP_BULANAN, {
                            method: "POST",
                            headers: {"Content-Type": "application/json"},
                            body: JSON.stringify({ data: [data] })
                        });
                        
                        const result = await res.json();
                        if (result.created === 1) sukses++;
                    } catch (e) {
                        console.error(`Gagal menyimpan data ${data['Nama Siswa']}:`, e);
                    }
                }
                
                if (sukses === totalData) {
                    alert("‚úÖ Semua data rekap berhasil disimpan (satu per satu)");
                } else if (sukses > 0) {
                    alert(`‚ö†Ô∏è ${sukses}/${totalData} data rekap berhasil disimpan`);
                } else {
                    alert("‚ùå Gagal menyimpan semua data rekap");
                }
            }
            
            // Muat ulang rekap untuk menampilkan data terbaru
            loadRekapBulanan(bulan, tahun);
        }
    </script>
</body>
</html>